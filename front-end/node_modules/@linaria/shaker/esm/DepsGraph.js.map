{"version":3,"sources":["../src/DepsGraph.ts"],"names":["types","t","resolveNode","addEdge","a","b","dependencies","has","get","edges","push","add","set","Set","dependents","DepsGraph","processQueue","actionQueue","length","action","resolvedA","resolvedB","call","getAllReferences","id","name","split","declaration","scope","getDeclaration","allReferences","Array","from","filter","i","isIdentifier","constructor","Map","dependent","dependency","addExport","node","exports","getDependenciesByBinding","includes","getDependentsByBinding","findDependencies","like","shallowEqual","map","findDependents","getDependencies","nodes","reduce","acc","concat","getLeafs","only","values"],"mappings":"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","sourcesContent":["import { types as t } from '@babel/core';\nimport type { Identifier, Node } from '@babel/types';\nimport ScopeManager, { PromisedNode, resolveNode } from './scope';\n\ntype Action = (this: DepsGraph, a: Node, b: Node) => void;\n\nfunction addEdge(this: DepsGraph, a: Node, b: Node) {\n  if (this.dependencies.has(a) && this.dependencies.get(a)!.has(b)) {\n    // edge has been already added∂ƒ\n    return;\n  }\n\n  this.edges.push([a, b]);\n  if (this.dependencies.has(a)) {\n    this.dependencies.get(a)!.add(b);\n  } else {\n    this.dependencies.set(a, new Set([b]));\n  }\n\n  if (this.dependents.has(b)) {\n    this.dependents.get(b)!.add(a);\n  } else {\n    this.dependents.set(b, new Set([a]));\n  }\n}\n\nexport default class DepsGraph {\n  public readonly imports: Map<string, Identifier[]> = new Map();\n  public readonly importAliases: Map<Identifier, string> = new Map();\n  public readonly importTypes: Map<string, 'wildcard' | 'default'> = new Map();\n\n  protected readonly edges: Array<[Node, Node]> = [];\n  protected readonly exports: Map<string, Node> = new Map();\n  protected readonly dependencies: Map<Node, Set<Node>> = new Map();\n  protected readonly dependents: Map<Node, Set<Node>> = new Map();\n\n  private actionQueue: Array<\n    [Action, Node | PromisedNode, Node | PromisedNode]\n  > = [];\n\n  private processQueue() {\n    if (this.actionQueue.length === 0) {\n      return;\n    }\n\n    for (const [action, a, b] of this.actionQueue) {\n      const resolvedA = resolveNode(a);\n      const resolvedB = resolveNode(b);\n      if (resolvedA && resolvedB) {\n        action.call(this, resolvedA, resolvedB);\n      }\n    }\n\n    this.actionQueue = [];\n  }\n\n  private getAllReferences(id: string): Identifier[] {\n    const [, name] = id.split(':');\n    const declaration = this.scope.getDeclaration(id)!;\n    const allReferences = [\n      ...Array.from(this.dependencies.get(declaration) || []),\n      ...Array.from(this.dependents.get(declaration) || []),\n    ].filter((i) => t.isIdentifier(i) && i.name === name) as Identifier[];\n    allReferences.push(declaration);\n    return allReferences;\n  }\n\n  constructor(protected scope: ScopeManager) {}\n\n  addEdge(dependent: Node | PromisedNode, dependency: Node | PromisedNode) {\n    this.actionQueue.push([addEdge, dependent, dependency]);\n  }\n\n  addExport(name: string, node: Node) {\n    this.exports.set(name, node);\n  }\n\n  getDependenciesByBinding(id: string) {\n    this.processQueue();\n    const allReferences = this.getAllReferences(id);\n    const dependencies = [];\n    for (let [a, b] of this.edges) {\n      if (t.isIdentifier(a) && allReferences.includes(a)) {\n        dependencies.push(b);\n      }\n    }\n\n    return dependencies;\n  }\n\n  getDependentsByBinding(id: string) {\n    this.processQueue();\n    const allReferences = this.getAllReferences(id);\n    const dependents = [];\n    for (let [a, b] of this.edges) {\n      if (t.isIdentifier(b) && allReferences.includes(b)) {\n        dependents.push(a);\n      }\n    }\n\n    return dependents;\n  }\n\n  findDependencies(like: Object) {\n    this.processQueue();\n    return this.edges\n      .filter(([a]) => t.shallowEqual(a, like))\n      .map(([, b]) => b);\n  }\n\n  findDependents(like: object) {\n    this.processQueue();\n    return this.edges\n      .filter(([, b]) => t.shallowEqual(b, like))\n      .map(([a]) => a);\n  }\n\n  getDependencies(nodes: Node[]) {\n    this.processQueue();\n    return nodes.reduce(\n      (acc, node) => acc.concat(Array.from(this.dependencies.get(node) || [])),\n      [] as Node[]\n    );\n  }\n\n  getLeafs(only: string[] | null): Array<Node | undefined> {\n    this.processQueue();\n    return only\n      ? only.map((name) => this.exports.get(name))\n      : Array.from(this.exports.values());\n  }\n}\n"],"file":"DepsGraph.js"}