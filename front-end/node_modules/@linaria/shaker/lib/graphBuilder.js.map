{"version":3,"sources":["../src/graphBuilder.ts"],"names":["isVoid","node","t","isUnaryExpression","operator","GraphBuilder","GraphBuilderState","build","root","graph","constructor","rootNode","visit","isExportsIdentifier","isIdentifier","scope","getDeclaration","ScopeManager","globalExportsIdentifier","isMemberExpression","property","name","object","globalModuleIdentifier","isExportsAssigment","isAssignmentExpression","left","baseVisit","ignoreDeps","dependencies","isExpression","keys","key","subNode","Array","isArray","i","length","child","push","forEach","dep","addEdge","callbacks","callback","parent","parentKey","listIdx","right","isObjectExpression","properties","prop","isObjectProperty","value","addExport","isScopable","isFunction","new","isProgram","fnStack","visitors","action","visitor","shift","call","isDeclaration","pop","dispose"],"mappings":"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","sourcesContent":["import { types as t } from '@babel/core';\nimport type { AssignmentExpression, Node, VisitorKeys } from '@babel/types';\nimport { isNode, getVisitorKeys } from '@linaria/babel-preset';\nimport DepsGraph from './DepsGraph';\nimport GraphBuilderState from './GraphBuilderState';\nimport { getVisitors } from './Visitors';\nimport type { VisitorAction } from './types';\nimport ScopeManager from './scope';\n\nconst isVoid = (node: Node): boolean =>\n  t.isUnaryExpression(node) && node.operator === 'void';\n\nclass GraphBuilder extends GraphBuilderState {\n  static build(root: Node): DepsGraph {\n    return new GraphBuilder(root).graph;\n  }\n\n  constructor(rootNode: Node) {\n    super();\n\n    this.visit(rootNode, null, null, null);\n  }\n\n  private isExportsIdentifier(node: Node) {\n    if (\n      t.isIdentifier(node) &&\n      this.scope.getDeclaration(node) === ScopeManager.globalExportsIdentifier\n    ) {\n      return true;\n    }\n\n    return (\n      t.isMemberExpression(node) &&\n      t.isIdentifier(node.property) &&\n      node.property.name === 'exports' &&\n      t.isIdentifier(node.object) &&\n      this.scope.getDeclaration(node.object) ===\n        ScopeManager.globalModuleIdentifier\n    );\n  }\n\n  private isExportsAssigment(node: Node): node is AssignmentExpression {\n    if (\n      node &&\n      t.isAssignmentExpression(node) &&\n      t.isMemberExpression(node.left)\n    ) {\n      if (this.isExportsIdentifier(node.left)) {\n        // This is a default export like `module.exports = 42`\n        return true;\n      }\n\n      if (this.isExportsIdentifier(node.left.object)) {\n        // This is a named export like `module.exports.a = 42` or `exports.a = 42`\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  /*\n   * Implements a default behaviour for AST-nodes:\n   * • visits every child;\n   * • if the current node is an Expression node, adds all its children as dependencies.\n   *\n   * eg. BinaryExpression has children `left` and `right`,\n   * both of them are required for evaluating the value of the expression\n   */\n  baseVisit<TNode extends Node>(node: TNode, ignoreDeps = false) {\n    const dependencies = [];\n    const isExpression = t.isExpression(node);\n    const keys = getVisitorKeys(node);\n    for (const key of keys) {\n      // Ignore all types\n      if (key === 'typeArguments' || key === 'typeParameters') {\n        continue;\n      }\n\n      const subNode = node[key as keyof TNode];\n\n      if (Array.isArray(subNode)) {\n        for (let i = 0; i < subNode.length; i++) {\n          const child = subNode[i];\n          if (child && this.visit(child, node, key, i) !== 'ignore') {\n            dependencies.push(child);\n          }\n        }\n      } else if (\n        isNode(subNode) &&\n        this.visit(subNode, node, key) !== 'ignore'\n      ) {\n        dependencies.push(subNode);\n      }\n    }\n\n    if (isExpression && !ignoreDeps) {\n      dependencies.forEach((dep) => this.graph.addEdge(node, dep));\n    }\n\n    this.callbacks.forEach((callback) => callback(node));\n  }\n\n  visit<TNode extends Node, TParent extends Node>(\n    node: TNode,\n    parent: TParent | null,\n    parentKey: VisitorKeys[TParent['type']] | null,\n    listIdx: number | null = null\n  ): VisitorAction {\n    if (\n      this.isExportsAssigment(node) &&\n      !this.isExportsAssigment(node.right) &&\n      !isVoid(node.right)\n    ) {\n      if (\n        t.isMemberExpression(node.left) &&\n        t.isIdentifier(node.left.property)\n      ) {\n        if (\n          t.isIdentifier(node.left.object) &&\n          node.left.object.name === 'module'\n        ) {\n          // It's a batch or default export\n          if (t.isObjectExpression(node.right)) {\n            // Batch export is a very particular case.\n            // Each property of the assigned object is independent named export.\n            // We also need to specify all dependencies and call `visit` for every value.\n            this.visit(node.left, node, 'left');\n            node.right.properties.forEach((prop) => {\n              if (t.isObjectProperty(prop) && t.isIdentifier(prop.key)) {\n                this.visit(prop.value, prop, 'value');\n                this.graph.addExport(prop.key.name, prop);\n                this.graph.addEdge(prop, node.right);\n                this.graph.addEdge(prop, prop.key);\n                this.graph.addEdge(prop.key, prop.value);\n              }\n            });\n\n            this.graph.addEdge(node.right, node);\n            this.graph.addEdge(node, node.left);\n\n            // We have done all the required work, so stop here\n            return;\n          } else {\n            this.graph.addExport('default', node);\n          }\n        } else {\n          this.graph.addExport(node.left.property.name, node);\n        }\n      }\n    }\n\n    const isScopable = t.isScopable(node);\n    const isFunction = t.isFunction(node);\n\n    if (isScopable) this.scope.new(t.isProgram(node) || t.isFunction(node));\n    if (isFunction) this.fnStack.push(node);\n\n    const visitors = getVisitors(node);\n    let action: VisitorAction;\n    if (visitors.length > 0) {\n      let visitor;\n      while (!action && (visitor = visitors.shift())) {\n        action = visitor.call(this, node, parent, parentKey, listIdx);\n      }\n    } else {\n      this.baseVisit(node);\n    }\n\n    if (parent && action !== 'ignore' && t.isDeclaration(node)) {\n      // Declaration always depends on its scope\n      this.graph.addEdge(node, parent);\n    }\n\n    if (isFunction) this.fnStack.pop();\n    if (isScopable) this.scope.dispose();\n\n    return action;\n  }\n}\n\nexport default GraphBuilder.build;\n"],"file":"graphBuilder.js"}