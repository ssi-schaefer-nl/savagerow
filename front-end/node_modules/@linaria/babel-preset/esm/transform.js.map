{"version":3,"sources":["../src/transform.ts"],"names":["path","parseSync","transformFromAstSync","stylis","SourceMapGenerator","debug","loadOptions","STYLIS_DECLARATION","posixSep","posix","sep","babelPreset","require","resolve","transformUrl","url","outputFilename","sourceFilename","platformPath","relative","dirname","split","join","shouldTransformCode","code","test","extractCssFromAst","babelFileResult","options","metadata","transformedCode","map","linaria","sourceMap","version","toString","rules","replacements","dependencies","mappings","cssText","preprocessor","selector","text","use","context","decl","replace","match","p1","p2","p3","p4","filename","Object","keys","forEach","index","push","generated","line","column","original","start","name","source","cssSourceMapText","length","generator","file","mapping","addMapping","assign","setSourceContent","transform","inputSourceMap","pluginOptions","babelOptions","ast","caller","rootMode","presets","babelrc","configFile","sourceMaps","sourceFileName"],"mappings":"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","sourcesContent":["/**\n * This file exposes transform function that:\n * - parse the passed code to AST\n * - transforms the AST using Linaria babel preset ('./babel/index.js) and additional config defined in Linaria config file or passed to bundler configuration.\n * - runs generated CSS files through default of user-defined preprocessor\n * - generates source maps for CSS files\n * - return transformed code (without Linaria template literals), generated CSS, source maps and babel metadata from transform step.\n */\n\nimport path from 'path';\nimport { parseSync, transformFromAstSync } from '@babel/core';\nimport stylis from 'stylis';\nimport type { Mapping } from 'source-map';\nimport { SourceMapGenerator } from 'source-map';\nimport { debug } from '@linaria/logger';\nimport loadOptions from './utils/loadOptions';\nimport type { LinariaMetadata, Options, PreprocessorFn, Result } from './types';\n\nconst STYLIS_DECLARATION = 1;\nconst posixSep = path.posix.sep;\nconst babelPreset = require.resolve('./index');\n\nexport function transformUrl(\n  url: string,\n  outputFilename: string,\n  sourceFilename: string,\n  platformPath: typeof path = path\n) {\n  // Replace asset path with new path relative to the output CSS\n  const relative = platformPath.relative(\n    platformPath.dirname(outputFilename),\n    // Get the absolute path to the asset from the path relative to the JS file\n    platformPath.resolve(platformPath.dirname(sourceFilename), url)\n  );\n\n  if (platformPath.sep === posixSep) {\n    return relative;\n  }\n\n  return relative.split(platformPath.sep).join(posixSep);\n}\n\nexport function shouldTransformCode(code: string): boolean {\n  return /\\b(styled|css)/.test(code);\n}\n\nexport function extractCssFromAst(\n  babelFileResult: babel.BabelFileResult,\n  code: string,\n  options: Options\n) {\n  const { metadata, code: transformedCode, map } = babelFileResult;\n\n  if (\n    !metadata ||\n    !(metadata as babel.BabelFileMetadata & { linaria: LinariaMetadata })\n      .linaria\n  ) {\n    return {\n      code: transformedCode || '', // if there was only unused code we want to return transformed code which will be later removed by the bundler\n      sourceMap: map\n        ? {\n            ...map,\n            version: map.version.toString(),\n          }\n        : null,\n    };\n  }\n\n  const {\n    rules,\n    replacements,\n    dependencies,\n  } = (metadata as babel.BabelFileMetadata & {\n    linaria: LinariaMetadata;\n  }).linaria;\n  const mappings: Mapping[] = [];\n\n  let cssText = '';\n\n  let preprocessor: PreprocessorFn;\n  if (typeof options.preprocessor === 'function') {\n    // eslint-disable-next-line prefer-destructuring\n    preprocessor = options.preprocessor;\n  } else {\n    switch (options.preprocessor) {\n      case 'none':\n        preprocessor = (selector, text) => `${selector} {${text}}\\n`;\n        break;\n      case 'stylis':\n      default:\n        stylis.use(null)((context, decl) => {\n          const { outputFilename } = options;\n          if (context === STYLIS_DECLARATION && outputFilename) {\n            // When writing to a file, we need to adjust the relative paths inside url(..) expressions\n            // It'll allow css-loader to resolve an imported asset properly\n            return decl.replace(\n              /\\b(url\\(([\"']?))(\\.[^)]+?)(\\2\\))/g,\n              (match, p1, p2, p3, p4) =>\n                p1 + transformUrl(p3, outputFilename, options.filename) + p4\n            );\n          }\n\n          return decl;\n        });\n\n        preprocessor = stylis;\n    }\n  }\n\n  Object.keys(rules).forEach((selector, index) => {\n    mappings.push({\n      generated: {\n        line: index + 1,\n        column: 0,\n      },\n      original: rules[selector].start!,\n      name: selector,\n      source: '',\n    });\n\n    // Run each rule through stylis to support nesting\n    cssText += `${preprocessor(selector, rules[selector].cssText)}\\n`;\n  });\n\n  return {\n    code: transformedCode || '',\n    cssText,\n    rules,\n    replacements,\n    dependencies,\n    sourceMap: map\n      ? {\n          ...map,\n          version: map.version.toString(),\n        }\n      : null,\n\n    get cssSourceMapText() {\n      if (mappings?.length) {\n        const generator = new SourceMapGenerator({\n          file: options.filename.replace(/\\.js$/, '.css'),\n        });\n\n        mappings.forEach((mapping) =>\n          generator.addMapping(\n            Object.assign({}, mapping, { source: options.filename })\n          )\n        );\n\n        generator.setSourceContent(options.filename, code);\n\n        return generator.toString();\n      }\n\n      return '';\n    },\n  };\n}\n\nexport default function transform(code: string, options: Options): Result {\n  // Check if the file contains `css` or `styled` words first\n  // Otherwise we should skip transforming\n  if (!shouldTransformCode(code)) {\n    return {\n      code,\n      sourceMap: options.inputSourceMap,\n    };\n  }\n\n  debug(\n    'transform',\n    `${options.filename} to ${options.outputFilename}\\n${code}`\n  );\n\n  const pluginOptions = loadOptions(options.pluginOptions);\n  const babelOptions = pluginOptions?.babelOptions ?? null;\n\n  // Parse the code first so babel uses user's babel config for parsing\n  // We don't want to use user's config when transforming the code\n  const ast = parseSync(code, {\n    ...babelOptions,\n    filename: options.filename,\n    caller: { name: 'linaria' },\n  });\n\n  const babelFileResult = transformFromAstSync(ast!, code, {\n    ...(babelOptions?.rootMode ? { rootMode: babelOptions.rootMode } : null),\n    filename: options.filename,\n    presets: [[babelPreset, pluginOptions]],\n    babelrc: false,\n    configFile: false,\n    sourceMaps: true,\n    sourceFileName: options.filename,\n    inputSourceMap: options.inputSourceMap,\n  })!;\n\n  return extractCssFromAst(babelFileResult, code, options);\n}\n"],"file":"transform.js"}